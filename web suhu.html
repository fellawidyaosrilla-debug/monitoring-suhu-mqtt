<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Suhu & Kelembapan - MQTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* Animasi kedip untuk peringatan */
        .alert-flash { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { background-color: #ffffff; }
            50% { background-color: #fee2e2; }
            100% { background-color: #ffffff; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-6">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Monitoring Realtime (MQTT)</h1>
                <p class="text-gray-500">Status: <span id="status" class="text-orange-500 font-bold">Menghubungkan...</span></p>
            </div>
            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                Export ke Excel
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div id="temp-card" class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-orange-500 transition-all duration-500">
                <p class="text-gray-400 font-semibold uppercase text-sm">Temperatur</p>
                <div class="flex items-center mt-2">
                    <span id="temp-val" class="text-5xl font-bold text-orange-500">00.0</span>
                    <span class="text-2xl text-gray-400 ml-2">°C</span>
                </div>
                <div id="alert-container"></div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-500">
                <p class="text-gray-400 font-semibold uppercase text-sm">Kelembapan</p>
                <div class="flex items-center mt-2">
                    <span id="hum-val" class="text-5xl font-bold text-blue-500">00.0</span>
                    <span class="text-2xl text-gray-400 ml-2">%</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">Grafik Suhu</h3>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">Grafik Kelembapan</h3>
                <canvas id="humChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI MQTT ---
        // GANTI nama topik ini agar sama dengan yang ada di kodingan ESP32 Anda
        const TOPIC_SUHU = "monitoring/suhu/user123"; 
        const TOPIC_HUM  = "monitoring/kelembapan/user123";
        const BROKER_URL = "wss://broker.emqx.io:8084/mqtt";

        let currentSuhu = 0;
        let currentHum = 0;

        // --- 2. INISIALISASI GRAFIK ---
        const ctxTemp = document.getElementById('tempChart').getContext('2d');
        const ctxHum = document.getElementById('humChart').getContext('2d');

        const chartConfig = (label, color) => ({
            type: 'line',
            data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.4 }] },
            options: { responsive: true, scales: { y: { beginAtZero: false } } }
        });

        const tempChart = new Chart(ctxTemp, chartConfig('Suhu (°C)', '#f97316'));
        const humChart = new Chart(ctxHum, chartConfig('Kelembapan (%)', '#3b82f6'));

        // --- 3. LOGIKA UPDATE TAMPILAN ---
        function updateDashboard(suhu, kelembapan) {
            const tempVal = document.getElementById("temp-val");
            const humVal = document.getElementById("hum-val");
            const tempCard = document.getElementById("temp-card");
            const alertContainer = document.getElementById("alert-container");

            // Update Angka
            tempVal.innerText = suhu.toFixed(1);
            humVal.innerText = kelembapan.toFixed(1);

            // LOGIKA PERINGATAN > 27
            if (suhu > 27) {
                tempCard.classList.replace("border-orange-500", "border-red-600");
                tempCard.classList.add("alert-flash");
                tempVal.classList.replace("text-orange-500", "text-red-600");
                if (!document.getElementById("alert-text")) {
                    alertContainer.innerHTML = `<p id="alert-text" class="text-red-600 font-bold mt-2 animate-bounce">⚠️ BAHAYA: SUHU DI ATAS 27°C!</p>`;
                }
            } else {
                tempCard.classList.replace("border-red-600", "border-orange-500");
                tempCard.classList.remove("alert-flash");
                tempVal.classList.replace("text-red-600", "text-orange-500");
                alertContainer.innerHTML = "";
            }

            // Update Grafik
            const waktuSekarang = new Date().toLocaleTimeString();
            updateChart(tempChart, waktuSekarang, suhu);
            updateChart(humChart, waktuSekarang, kelembapan);
        }

        function updateChart(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(data);
            if (chart.data.labels.length > 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        }

        // --- 4. KONEKSI KE BROKER MQTT ---
        const client = mqtt.connect(BROKER_URL);

        client.on('connect', () => {
            document.getElementById("status").innerText = "Terhubung";
            document.getElementById("status").className = "text-green-500 font-bold";
            console.log("Terhubung ke MQTT via WebSocket");
            client.subscribe(TOPIC_SUHU);
            client.subscribe(TOPIC_HUM);
        });

        client.on('message', (topic, message) => {
            const payload = parseFloat(message.toString());
            
            if (topic === TOPIC_SUHU) {
                currentSuhu = payload;
            } else if (topic === TOPIC_HUM) {
                currentHum = payload;
            }
            
            // Perbarui dashboard setiap ada data masuk
            updateDashboard(currentSuhu, currentHum);
        });

        client.on('error', (err) => {
            document.getElementById("status").innerText = "Gagal Terhubung";
            document.getElementById("status").className = "text-red-500 font-bold";
            console.error(err);
        });

    </script>
</body>
</html>